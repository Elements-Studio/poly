package starcoin

import (
	"bytes"
	"encoding/hex"
	"encoding/json"
	stc "github.com/starcoinorg/starcoin-go/client"
	"github.com/starcoinorg/starcoin-go/types"
	"reflect"
	"testing"
)

func TestVerifyEventProof(t *testing.T) {
	type args struct {
		proof   *TransactionInfoProof
		data    types.HashValue
		address []byte
	}
	//transactionInfo := stc.TransactionInfo{
	//	BlockHash:        "0xe79298f969573db42415b949ec8daa4e19abc680aa8c7e02cc22a2ad9f02fbf2",
	//	BlockNumber:      "0",
	//	TransactionHash:  "0x4978f0c2a31e2b927041bb050fd710aacc9e0575f3f383d7b8439e5d3996c41c",
	//	TransactionIndex: 4,
	//	StateRootHash:    "0x7f534a6e7f8312658c6ff0184c070da25d3f99ed1c85ac44a50f516c66e16f5f",
	//	EventRootHash:    "0xad7b6bbaefc8bf183a927001ee195a2c854fbf778f763bc3f72d6c1cfcf83f24",
	//	GasUsed:          "0",
	//	Status:           "Executed",
	//}
	transactionInfo := stc.TransactionInfo{
		BlockHash:        "0x37e8dd4f432a1c3a7b6dfcaa90ebf2aafa0287678ffe4b8ad2373c5b48ffb20c",
		BlockNumber:      "208141",
		TransactionHash:  "0x161331d2e851c6752f570d461ad9936b2bae4c376f558019de99beed5b38b0be",
		TransactionIndex: 462376,
		StateRootHash:    "0x48fcc4aa0eb6751c29cda2fb54d937d63291e0748af1df239107c486661eac46",
		EventRootHash:    "0x3ce91f0d2d44656259141c436aa22109f51baf381fc4927789b54762c632d884",
		GasUsed:          "621382",
		Status:           "Executed",
	}
	//bytes3, _ := hex.DecodeString("85d30ad69568d0269f7b2ad327b9acf3585869403a399155b23d29cb2bffc173")
	bytes3, _ := hex.DecodeString("e8ad8431730b1444fb9e97066dda113756701ed8aa354381bbfccaa9eb9ec4b1")
	txnAccumulatorRoot := types.HashValue(bytes3)

	proof := TransactionInfoProof{
		TransactionInfo: transactionInfo,
		//Proof:           "{\"siblings\":[\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x57d6deb1e9ec9de95f858dff0d4dc6460b2c7acd6f159459999c50bc317f0b25\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x7de2c2fbf68eea9054afe3c935486392e212ca1bd15d833b496f608391256cf3\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x9b3db9d9280f61697d70cd55daa918b153c489ab8e58edc5f31baaeaac4f62c0\",\"0x729af03fc86eb6fe324c8fc8b497e3bd8f06545bc236fb4e514ee62b9bc28b30\",\"0x411151b2deaea75a1292ab28b282b23a55151028babe5f7e45adeb99060bf6e7\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x8483fe396477fabde168d2fc7157f4da104b1b0bdb24546106e2431394e440cf\",\"0xb8430591e9bc195ba37f3fe547bf17c811329ba4502c7026b23dd90412cc8d20\",\"0x0e475fde7a9b246667cb2959040806f7fc1c3b838bc57ac7fb7ffdcf2cd83e09\"]}",
		Proof:      "{\"siblings\":[\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x57d6deb1e9ec9de95f858dff0d4dc6460b2c7acd6f159459999c50bc317f0b25\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x7de2c2fbf68eea9054afe3c935486392e212ca1bd15d833b496f608391256cf3\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x9b3db9d9280f61697d70cd55daa918b153c489ab8e58edc5f31baaeaac4f62c0\",\"0x729af03fc86eb6fe324c8fc8b497e3bd8f06545bc236fb4e514ee62b9bc28b30\",\"0x411151b2deaea75a1292ab28b282b23a55151028babe5f7e45adeb99060bf6e7\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x414343554d554c41544f525f504c414345484f4c4445525f4841534800000000\",\"0x8483fe396477fabde168d2fc7157f4da104b1b0bdb24546106e2431394e440cf\",\"0xb8430591e9bc195ba37f3fe547bf17c811329ba4502c7026b23dd90412cc8d20\",\"0x0e475fde7a9b246667cb2959040806f7fc1c3b838bc57ac7fb7ffdcf2cd83e09\"]}",
		eventIndex: 0,
		//EventWithProof:  "{\"event\":{\"V0\":{\"key\":\"0x0e0000000000000000000000000000000000000000000001\",\"sequence_number\":0,\"type_tag\":{\"Struct\":{\"address\":\"0x00000000000000000000000000000001\",\"module\":\"Token\",\"name\":\"MintEvent\",\"type_params\":[]}},\"event_data\":[0,0,79,1,81,224,51,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,3,83,84,67,3,83,84,67]}},\"proof\":{\"siblings\":[\"0xe886665a7b12325d365c4991b3b7e306492f0ad565f692f66a0d41dce519e65a\",\"0xa94cc80c5a33aca23b6cfdc72c76acbd17adf9824acf8003e013ac02318c6580\",\"0xeb6ee4ac69b77d980aed9cc8f63a2cc5755e67efd77479e567f7d7a547f9c746\"]}}",
		EventWithProof: "{\"event\":\"0x00180500000000000000e498d62f5d1f469d2f72eb3e9dc8f230020000000000000007e498d62f5d1f469d2f72eb3e9dc8f2301143726f7373436861696e4d616e616765720f43726f7373436861696e4576656e7400de0210e498d62f5d1f469d2f72eb3e9dc8f230100000000000000000000000000000000235307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e4d616e61676572da0000000000000034307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e536372697074c7011000000000000000000000000000000002208f5e5f785723333b2ab129a7928d1d47129a4df840da708d25086f1a361e0f6910e498d62f5d1f469d2f72eb3e9dc8f230da0000000000000034307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e53637269707406756e6c6f636b3f0d3078313a3a5354433a3a535443102d81a0427d64ff61b11ede9085efa5ad1027000000000000000000000000000000000000000000000000000000000000\",\"proof\":{\"siblings\":[\"0x250e94bc6aefc2909af74e7c621efcd081eee7eed2539593efef9537d0db2c34\",\"0xe849d5eeef3128bb774a35f9a2926504af880fa27dccdd7f4d2ced4e284a68d8\"]}}",
		//StateWithProof:  "{\"state\":[32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,24,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,24,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],\"proof\":{\"account_state\":{\"blob\":[2,1,32,58,226,188,223,103,199,252,196,31,4,212,81,21,143,93,79,149,162,70,123,31,238,107,125,247,44,159,65,152,129,133,161,1,32,164,13,61,251,134,239,253,169,107,217,46,216,205,61,35,206,212,129,117,216,182,217,11,11,123,133,198,187,215,146,14,127]},\"account_proof\":{\"leaf\":[\"0xf1232a8cea9ae1d59147fcde30471108ec89c04579567e7aababc351b77ef1b6\",\"0xdfeab852f4f71945e94a5409c8283fcb32addef08ddd3d0ae9814de93a83efb3\"],\"siblings\":[\"0x360c7b79a7d2cc064e3af7befe431ac36613f62419afe2319a571ce2719f6202\",\"0x5350415253455f4d45524b4c455f504c414345484f4c4445525f484153480000\",\"0x5350415253455f4d45524b4c455f504c414345484f4c4445525f484153480000\"]},\"account_state_proof\":{\"leaf\":[\"0x9b079b5aef808c36133c95bacbc3d3411d1e8cce4fbc4b524ffab31202eaaa11\",\"0x91354856a1026edb028bc4aa72877a508483f3c9daef045b1d499cbf227fd0f7\"],\"siblings\":[\"0x318db4c3c46dc7b422e5dbda750952df1aa70387ab1331a8e0e39492a7fab69f\",\"0x5350415253455f4d45524b4c455f504c414345484f4c4445525f484153480000\",\"0x038cd2d75dbad3944f7476cb8e0c808e22a538e058ec0dd6a4508ba98d3a82b4\",\"0x77b69f571a7672871e87967a0d714613efa88ce20f28fa65b9f2c4b4748e2ee1\",\"0x8349b139ef1233c993be3376f07a5a9fa0b5973e22867c3142636d7d5d908e22\",\"0xcb174d26a2565684d3673ab2a01a3bf6273f38bf8d8c329beb85a9c3729449e1\"]}}}",
		StateWithProof: "",
		//accessPath:      "000000000000000000000000000000010100000000000000000000000000000001074163636f756e74074163636f756e7400",
		accessPath: "",
	}
	//eventData := []byte{0, 0, 79, 1, 81, 224, 51, 44, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 83, 84, 67, 3, 83, 84, 67}
	eventData := []byte{16, 228, 152, 214, 47, 93, 31, 70, 157, 47, 114, 235, 62, 157, 200, 242, 48, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 53, 48, 120, 101, 52, 57, 56, 100, 54, 50, 102, 53, 100, 49, 102, 52, 54, 57, 100, 50, 102, 55, 50, 101, 98, 51, 101, 57, 100, 99, 56, 102, 50, 51, 48, 58, 58, 67, 114, 111, 115, 115, 67, 104, 97, 105, 110, 77, 97, 110, 97, 103, 101, 114, 218, 0, 0, 0, 0, 0, 0, 0, 52, 48, 120, 101, 52, 57, 56, 100, 54, 50, 102, 53, 100, 49, 102, 52, 54, 57, 100, 50, 102, 55, 50, 101, 98, 51, 101, 57, 100, 99, 56, 102, 50, 51, 48, 58, 58, 67, 114, 111, 115, 115, 67, 104, 97, 105, 110, 83, 99, 114, 105, 112, 116, 199, 1, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 32, 143, 94, 95, 120, 87, 35, 51, 59, 42, 177, 41, 167, 146, 141, 29, 71, 18, 154, 77, 248, 64, 218, 112, 141, 37, 8, 111, 26, 54, 30, 15, 105, 16, 228, 152, 214, 47, 93, 31, 70, 157, 47, 114, 235, 62, 157, 200, 242, 48, 218, 0, 0, 0, 0, 0, 0, 0, 52, 48, 120, 101, 52, 57, 56, 100, 54, 50, 102, 53, 100, 49, 102, 52, 54, 57, 100, 50, 102, 55, 50, 101, 98, 51, 101, 57, 100, 99, 56, 102, 50, 51, 48, 58, 58, 67, 114, 111, 115, 115, 67, 104, 97, 105, 110, 83, 99, 114, 105, 112, 116, 6, 117, 110, 108, 111, 99, 107, 63, 13, 48, 120, 49, 58, 58, 83, 84, 67, 58, 58, 83, 84, 67, 16, 45, 129, 160, 66, 125, 100, 255, 97, 177, 30, 222, 144, 133, 239, 165, 173, 16, 39, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}
	tests := []struct {
		name    string
		args    args
		want    []byte
		wantErr bool
	}{
		{"test event proof",
			args{
				proof: &proof,
				data:  txnAccumulatorRoot,
			},
			eventData,
			false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, err := VerifyEventProof(tt.args.proof, tt.args.data, tt.args.address)
			if (err != nil) != tt.wantErr {
				t.Errorf("VerifyEventProof() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if !bytes.Equal(got, tt.want) {
				t.Errorf("VerifyEventProof() got = %v, want %v", got, tt.want)
			}
		})
	}
}

func Test_internalHash(t *testing.T) {
	type args struct {
		index    int
		elements []byte
		sibling  []byte
	}
	left, _ := hex.DecodeString("21b129ad214b45d4d5f46f6b3a1853181797d871de09cf4dc234195bebf0820f")
	right, _ := hex.DecodeString("1d8a1b360faa73a3e86a2fba321edad502035e915f3b75b71791fc68d052e27b")
	internal, _ := hex.DecodeString("17b38596329fb9bebb56bf9e890645e3f72b688749c9bbeca57b633406b17169")
	tests := []struct {
		name string
		args args
		want []byte
	}{
		{
			name: "test internal hash",
			args: args{
				index:    0,
				elements: left,
				sibling:  right,
			},
			want: internal,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			if got := internalHash(tt.args.index, tt.args.elements, tt.args.sibling); !reflect.DeepEqual(got, tt.want) {
				t.Errorf("internalHash() = %v, want %v", got, tt.want)
			}
		})
	}
}

func TestEvent(t *testing.T) {
	event := "{\"V0\":{\"key\":\"0x0e0000000000000000000000000000000000000000000001\",\"sequence_number\":1}}"
	var contract ContractEvent
	err := json.Unmarshal([]byte(event), &contract)
	if err != nil {
		println(err)
	}

	var e Event
	ebyte, _ := hex.DecodeString("0x00180500000000000000e498d62f5d1f469d2f72eb3e9dc8f230020000000000000007e498d62f5d1f469d2f72eb3e9dc8f2301143726f7373436861696e4d616e616765720f43726f7373436861696e4576656e7400de0210e498d62f5d1f469d2f72eb3e9dc8f230100000000000000000000000000000000235307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e4d616e61676572da0000000000000034307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e536372697074c7011000000000000000000000000000000002208f5e5f785723333b2ab129a7928d1d47129a4df840da708d25086f1a361e0f6910e498d62f5d1f469d2f72eb3e9dc8f230da0000000000000034307865343938643632663564316634363964326637326562336539646338663233303a3a43726f7373436861696e53637269707406756e6c6f636b3f0d3078313a3a5354433a3a535443102d81a0427d64ff61b11ede9085efa5ad1027000000000000000000000000000000000000000000000000000000000000")
	err = json.Unmarshal([]byte(ebyte), &e)
	if err != nil {
		println(err)
	}
	println(e.SequenceNumber)
}

func Test_verifyAccumulator(t *testing.T) {
	type args struct {
		proof        AccumulatorProof
		expectedRoot types.HashValue
		hash         types.HashValue
		index        int
	}
	sibling0, _ := hex.DecodeString("49749e95c8df29d59fad98cc1cc5fb049a5cb016f400724e16c5389b0433be21")
	sibling1, _ := hex.DecodeString("71cafa34205ab0d7c0b087ab5407bf056b471b4cbe0273059f214ca37e421b9f")
	sibling2, _ := hex.DecodeString("272385029ccb0b5035d7189cbb6effbf8c78fabc1de2464e324d566cb85580ec")
	sibling3, _ := hex.DecodeString("c0d1b51dbbf6f194ae2a05af749ca3570e8b202db7e46f22f2b2ef853d487cde")

	left, _ := hex.DecodeString("4978f0c2a31e2b927041bb050fd710aacc9e0575f3f383d7b8439e5d3996c41c")
	internal, _ := hex.DecodeString("85d30ad69568d0269f7b2ad327b9acf3585869403a399155b23d29cb2bffc173")

	tests := []struct {
		name    string
		args    args
		want    bool
		wantErr bool
	}{
		{
			name: "test verifyAccumulator",
			args: args{
				index:        4,
				expectedRoot: internal,
				hash:         left,
				proof:        AccumulatorProof{siblings: []types.HashValue{types.HashValue(sibling0), types.HashValue(sibling1), types.HashValue(sibling2), types.HashValue(sibling3)}},
			},
			want: true,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, err := verifyAccumulator(tt.args.proof, tt.args.expectedRoot, tt.args.hash, tt.args.index)
			if (err != nil) != tt.wantErr {
				t.Errorf("verifyAccumulator() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if got != tt.want {
				t.Errorf("verifyAccumulator() got = %v, want %v", got, tt.want)
			}
		})
	}
}
